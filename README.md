# refrigerator-simulation
# ❄️ 模拟冰箱系统 ❄️  
*基于 STM32 标准库及若干外设，搭建一个模拟冰箱的系统。*

---

## 🧩 外设模块  
| 编号 | 模块 | 图标 |
|---|---|---|
| 1 | EC11 旋钮编码器 | 🎛️ |
| 2 | TB6612 电机驱动模块 | ⚡ |
| 3 | 5 V 直流电机 | 🌀 |
| 4 | AT24C02（EEPROM） | 💾 |
| 5 | DHT20 温湿度传感器 | 🌡️ |
| 6 | 蜂鸣器 | 🔊 |
| 7 | ESP8266 无线 Wi-Fi 模块 | 📶 |
| 8 | LED 灯泡 | 💡 |
| 9 | 0.96 寸 OLED 模块 | 📺 |
|10 | ST-Link | 🔗 |

---

## ✅ 实现的基础功能及依赖模块

### 一、基础功能  
1. 🌡️ **检测恒温**：实时检测环境温湿度，并显示环境温度（DHT20 + OLED + I²C + 状态机）  
2. 🎛️ **温度调整**：用户通过旋钮设定目标温度，并显示（EC11 + OLED）  
3. 🔊 **蜂鸣器警报**：特定条件下间歇鸣响（蜂鸣器 + 状态机）  
4. 🚪 **按键开关**：用于模拟冰箱门开闭（按键模块/跳线 + GPIO）  
5. 💡 **食物照明灯**：用于照亮箱内空间（LED 灯泡 + GPIO）  
6. 🌀 **压缩机运行**：制冷核心，用 5 V 直流电机模拟（5 V 直流电机 + PWM）  
7. 📶 **联网功能**：连接指定网络并请求网络事件，解析出时间戳（ESP8266 + 串口通信）  
8. ⏰ **自带时钟**：开启后启动计时器记录时间（RTC 实时时钟）  
9. 💾 **存储数据**：预留了一个 EEPROM，用于存储数据（AT24C02）  
10. ⏲️ **定时器**：定时中断，用于非阻塞状态机的实现（蜂鸣器间歇鸣响、DHT20 模块）  
11. 📊 **显示状态**：显示冰箱各个数据，包括环境温度、设定温度、计数器检测是否阻塞、实时时间戳、开关门状态、开关门次数（0.96 寸 OLED 模块）

---

### 二、组合功能  
| 功能 | 描述 | 依赖基础功能 |
|---|---|---|
| 🧊 **控温** | 直流电机基于环境温度与目标温度差，自动调整转速，模拟压缩机运转 | 1+2+6+10 |
| 🚪💡 **开门亮灯** | 打开冰箱门后，箱内灯光自动点亮 | 4+5 |
| ⚠️ **未关门报警** | 打开门冰箱长时间未关闭，报警提示，蜂鸣器间歇鸣响 | 3+4+5+10 |
| 🕒 **记录开门时间点** | 用户开门后，记录当前时间，并存储起来 | 4+7+8+9 |
| 📈 **显示开关门次数及状态** | 将开关状态、次数显示在 OLED 屏幕上 | 4+11 |

---

&gt; 🛠️ *Have fun hacking!* 欢迎提 Issue & PR 一起完善～
### 📐三、原理图
<img width="1193" height="837" alt="原理图0921" src="https://github.com/user-attachments/assets/64ae88e6-b4de-4407-b6a7-475ade366ac2" />

### 📸四、实物图
![实物图0921](https://github.com/user-attachments/assets/40de62c7-8385-4e3d-bc00-98a9e93b55e0)

### 🔍 五、遇到的坑  
写代码其实大部分时间都在找 Bug，聊一聊我做这个项目过程中遇到的坑吧～

---

#### 1️⃣ ESP8266 模块串口收发时间戳数据  
📡 **现象**：  
接收并用 `sscanf` 解析 NTP 返回的时间信息，判断返回信息里面有 `+CRISPTIME：` 就认为返回正确，然后用 `sscanf` 解析返回的时间信息，总是解析不出 24 个字节以后的数据。

🔍 **原因**：  
串口接发数据需要时间，因为用的是中断接收，所以主程序一直在运行。运行到用 `strstr` 解析数据时，串口正好只接收到第 24 个字节，所以导致解析失败。

✅ **解决办法**：  
用 `"OK"` 判断返回数据已经接收完毕。

💬 **备注**：  
这个问题我间歇研究了一个周才搞定 - -。

---

#### 2️⃣ DHT20 数据读取  
🌡️ **坑点合集**：

| 编号 | 问题描述 | 图标 |
|---|---|---|
| ① | 数据手册读取状态后应该是主机回复，而图片上写的是从机应答 | 📖❌ |
| ② | 手册中描述：“等待 80 ms 待测量完成，如果读取状态字 Bit[7] 为 0，表示测量完成，然后可以连续读取六个字节；否则继续等待”。实际上状态字节也是这连续六个字节中的一个，其实可以直接连续读取 7 个字节，只解析第 2~6 个字节即可 | 🕵️‍♂️ |
| ③ | 现象：初始化后，搜寻线上所有从机地址，发现每个地址都有应答。原因：收到的 DHT20 模块是坏的，应该是内部短路，导致 SDA 一直为 0 | ⚠️🔌 |

---

#### 3️⃣ EC11 旋钮编码器  
🎛️ **现象**：  
江协科技给的 EC11 旋钮编码器中间电路图是带按键的，有个 C 可以接线，按下后导通，但实测发现没有任何用处。

✅ **结论**：  
如果想使用按键，需要单独去别处购买明确说带按键的 EC11 旋钮编码器。

---

> 🛠️ 踩坑不息，Debug 不止！  
> 希望上面的小笔记能帮到你，也欢迎来 [Issues](https://github.com/DeepSleepKiller/refrigerator-simulation/issues) 分享你的踩坑故事～
